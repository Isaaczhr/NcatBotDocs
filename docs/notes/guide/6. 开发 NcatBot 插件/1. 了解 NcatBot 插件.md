---
title: 了解 NcatBot 插件
createTime: 2025/02/08 10:07:54
permalink: /guide/dplugins/
---

## NcatBot 插件

在了解 NcatBot 插件之前, 请至少先阅读 [快速开始](../1.%20快速开始/1.%20快速开始.md) 的两部分内容.

NcatBot 的插件位于工作目录下 `plugins` 文件夹中, 每个插件都是一个独立的文件夹.

使用 `bot.run()` 启动 NcatBot 时, 会自动加载所有插件.

一个插件包含以下文件:

::: file-tree
- your_plugin
  - folder1
    - subfolder1-1
      - file1-1-1.yaml
      - file1-1-2.py
    - subfolder1-2
      - file1-2-1.py
      - file1-2-2.py
  - folder2
    - file2-2.py
  - main.py
  - \_\_init\_\_.py
  - requirements.txt
  - README.md
:::

其中, `__init__.py` 用于声明插件, 是必须的, 其余文件都是可选的.

## 声明插件

在 `__init__.py` 中, 需要声明插件, 例如:

```python
from .main import MyPlugin

__all__ = ["MyPlugin"]
```

- 第一行: 导入插件类.
- 第二行: 空行, 好看.
- 第三行: 明确被导入的插件类.

NcatBot 不对工作目录做任何保证, 插件项目内部只建议使用**相对导入**.

## 最小示例

插件文件夹 `plugins/Myplugin` 下有两个文件.

```
plugins/Myplugin
│
├── main.py
└── __init__.py
```

### __init__.py

```python
# __init__.py
from .main import MyPlugin

__all__ = ["MyPlugin"]
```

### main.py

```python
# main.py
import os

from ncatbot.plugin.loader import BasePlugin, CompatibleEnrollment
from ncatbot.core.message import GroupMessage

bot = CompatibleEnrollment  # 兼容回调函数注册器


class MyPlugin(BasePlugin):
    name = "MyPlugin" # 插件名称
    version = "0.0.1" # 插件版本

    @bot.group_event()
    async def on_group_event(msg: GroupMessage):
        # 定义的回调函数
        if msg.raw_message == "测试":
            self.api.post_group_msg(msg.group_id, text="Ncatbot 插件测试成功喵")

    async def on_load(self):
        # 插件加载时执行的操作, 可缺省
        print(f"{self.name} 插件已加载")
        print(f"插件版本: {self.version}")
```

### 代码拆解

#### 导入

```python
from ncatbot.plugin.loader import BasePlugin, CompatibleEnrollment
from ncatbot.core.message import GroupMessage
```

- `BasePlugin`: 插件基类.
- `CompatibleEnrollment`: 兼容回调函数注册器.
- `GroupMessage`: 群消息类.

所有的插件必须是 `BasePlugin` 的派生类, 否则无法被正常加载.

`CompatibleEnrollment` 的用途是注册回调函数, 插件系统和主程序采用**两种不同的事件触发机制**, 为了方便开发, 提供了这个注册器.

#### 注册插件

```python
bot = CompatibleEnrollment  # 兼容回调函数注册器
class MyPlugin(BasePlugin):
    name = "MyPlugin" # 插件名称
    version = "0.0.1" # 插件版本

```

- `name = "MyPlugin"`: 插件名称. (必写)
- `version = "0.0.1"`: 插件版本. (必写)

#### 回调函数

```python
    @bot.group_event()
    async def on_group_event(msg: GroupMessage):
        # 定义的回调函数
        if msg.raw_message == "测试":
            self.api.post_group_msg(msg.group_id, text="Ncatbot 插件测试成功喵")
```

`BasePlugin.api` 是一个 `BotAPI` 对象, 参考 [API 调用](/api.md) 一节使用.

### 如何运行

- 保证 `ncatbot` 已经被安装到 Python 环境中.
- 工作目录下存在 `plugins/MyPlugin` 文件夹.
- 使用以下代码可直接运行:
    ```python
    from ncatbot.core.client import BotClient
    from ncatbot.utils.config import config

    config.set_bot_uin("123456")  # 设置 bot qq 号 (必填)
    config.set_ws_uri("ws://localhost:3001")  # 设置 napcat websocket server 地址
    config.set_token("") # 设置 token (napcat 服务器的 token)

    bot = BotClient()

    if __name__ == "__main__":
        bot.run(reload=False)
    ```

### 差异比较

- 直接使用 `NcatBot` 时, API 通过 `bot.api` 调用, 而插件系统通过 `self.api` 调用.
- 直接使用 `NcatBot` 时, 回调函数通过 `@bot.group_event()` 注册, `bot` 是一个 `BotClient` 实例, 而插件系统需要在 `MyPlugin` 里用 `@bot.group_event()` 注册, `bot` 是 `CompatibleEnrollment` 兼容注册器.
- 使用插件系统时, 无需再使用 `BotClient` 的回调函数注册修饰器注册回调函数, 所有的回调函数由插件注册.